import{bytesToInteger as e,integerToBytes as t}from"https://unpkg.com/@aicacia/hash@0/browser/index.js";import{MAX_INT as n}from"https://unpkg.com/@aicacia/rand@0/browser/index.js";const r=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,a=/^[ \t]+(.*[^ \t])/,o=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/,i=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/,s="\n".charCodeAt(0),c="\r".charCodeAt(0),w=new TextEncoder,d=new TextDecoder;class f extends Request{constructor(e,t){const n=t?.headers;if(super(e,t),n){const e=new Headers(n);Object.defineProperty(this,"headers",{value:e,writable:!1})}}}async function u(e,t={mode:"same-origin",credentials:"include"}){const n=b(e),[r,a]=await async function(e){const{done:t,value:n}=await e.readLine();if(t)throw new Error("Unexpected end of request");const r=o.exec(n);if(!r)throw new Error(`Invalid request line: ${n}`);return[r[1],r[2],+r[3],+r[4]]}(n),[i,s,c]=await h(n),w=g(n,s,c);return new f(a,{...t,method:r,headers:i,body:w,duplex:"half"})}async function l(e){const t=b(e),[n,r]=await async function(e){const{done:t,value:n}=await e.readLine();if(t)throw new Error("Unexpected end of request");const r=i.exec(n);if(!r)throw new Error(`Invalid response line: ${n}`);return[+r[3],r[4],+r[1],+r[2]]}(t),[a,o,s]=await h(t),c=g(t,o,s);return new Response(c,{status:n,statusText:r,headers:a})}async function y(e,t){const n=e.getWriter();let r=!1;try{const[a,o]=t instanceof Request?[t,null]:[null,t];a?await n.write(w.encode(`${a.method} ${a.url} HTTP/1.1\r\n`)):await n.write(w.encode(`HTTP/1.1 ${o.status} ${o.statusText}\r\n`));const i=new Headers(t.headers);if(t.body)if(a){const e=await async function(e){try{const{done:t,value:n}=await e.read();if(t)return new Uint8Array;let r=n;for(;;){const{done:t,value:n}=await e.read();if(t)break;r=m(r,n)}return r}finally{e.releaseLock()}}(t.body.getReader());i.set("Content-Length",`${e.byteLength}`);for(const[e,t]of i.entries())await n.write(w.encode(`${e}: ${t}\r\n`));await n.write(w.encode("\r\n")),await n.write(e)}else{const a=Number.parseInt(i.get("Content-Length")||"0",10),o="chunked"===i.get("Transfer-Encoding")?.toLowerCase();for(const[e,t]of i.entries())await n.write(w.encode(`${e}: ${t}\r\n`));await n.write(w.encode("\r\n")),n.releaseLock(),await(g(b(t.body.getReader()),o,a)?.pipeTo(e)),r=!0}else{for(const[e,t]of i.entries())await n.write(w.encode(`${e}: ${t}\r\n`));await n.write(w.encode("\r\n"))}}finally{r||(n.releaseLock(),e.close())}}async function h(e){const t=new Headers;let n=!1,o=0;for(;;){const{done:i,value:s}=await e.readLine();if(i)throw new Error("Unexpected end of headers");if(""===s)break;const c=r.exec(s);if(!c)throw new Error(`Invalid header line: ${s}`);let w=c[2];for(;;){const e=a.exec(w);if(!e)break;w=e[1]}const d=c[1].toLowerCase();"transfer-encoding"===d&&"chunked"===w.toLowerCase()?n=!0:"content-length"===d&&(o=+w),t.append(c[1],w)}return[t,n,o]}function g(e,t,n){if(!t&&0===n)return null;const a=new TransformStream;return async function(e,t,n,a){const o=t.getWriter();try{if(n)for(;;){const{done:t,value:n}=await e.readLine();if(t)throw new Error("Unexpected end of stream");if(r.exec(n)){await e.readLine();break}const a=Number.parseInt(n,16);if(!a)break;let i=a;for(;i>0;){const{done:t,value:n}=await e.read(a);if(t)throw new Error("Unexpected end of stream");i-=n.byteLength,await o.write(n)}await e.readLine()}else{let t=a;for(;t>0;){const{done:n,value:r}=await e.read(t);if(n)throw new Error("Unexpected end of stream");t-=r.byteLength,await o.write(r)}}}finally{e.releaseLock(),o.releaseLock(),t.close()}}(e,a.writable,t,n),a.readable}function b(e,t=4096){let n=new Uint8Array(t),r=0,a=0,o=!1;async function i(t){if(o)return t<a;for(;t>=a;){const{done:t,value:r}=await e.read();if(t){o=!0;break}n=L(n,a,r),a+=r.byteLength}return t<a}return{readLine:async function(){let e=r,t=await i(e);for(;t;){if(n[e]===s){const t=n[e-1]===c?e-1:e,a=d.decode(n.slice(r,t));return r=e+1,{done:!1,value:a}}e++,e>=a&&(t=await i(e))}return{done:!0}},read:async function(e){const t=r+e;await i(t-1);const o=Math.min(a-r,e);if(0===o)return{done:!0};const s=n.slice(r,r+o);return r+=o,{done:!1,value:s}},releaseLock:function(){e.releaseLock()}}}function m(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e),n.set(t,e.byteLength),n}function L(e,t,n){if(n.byteLength>=e.byteLength-t){const r=new Uint8Array(2*e.byteLength);return r.set(e),r.set(n,t),r}return e.set(n,t),e}function p(){return Math.random()*n|0}function v(e,t,n){return new WritableStream({write(r){!function(e,t,n){if(t.byteLength<n)e.send(t);else{let r=0;for(;r<t.byteLength;){const a=Math.min(n,t.byteLength-r);e.send(t.slice(r,r+a)),r+=a}}}(e,m(t,r),n)}})}function x(e,t=4096){const n=new Uint8Array(t);let r=0;const a=e.getWriter();async function o(){r>0&&(await a.write(n.slice(0,r)),r=0)}return new WritableStream({write:async function(e){let a=0;for(;a<e.byteLength;){r>=t&&await o();const i=Math.min(t-r,e.byteLength-a);n.set(e.slice(a,a+i),r),r+=i,a+=i}},async close(){await o(),await a.close()}})}function k(n){const r=new Map;async function a(t){const n=new Uint8Array(t.data),a=e(n);await async function(e,t){const n=r.get(e);if(!n)throw new Error(`No connection found for id: ${e}`);await n.writer.write(t)}(a,n.slice(4))}n.addEventListener("message",a);const o=(e,a)=>new Promise(((o,i)=>{const s=new f(e,a),c=function(){let e=p();for(;r.has(e);)e=p();const n=t(new Uint8Array(4),e),a=new TransformStream,o={idBytes:n,stream:a,writer:a.writable.getWriter()};return r.set(e,o),o}();y(x(v(n,c.idBytes,16384)),s).then((()=>l(c.stream.readable.getReader()).then(o))).catch(i)}));return o.destroy=()=>n.removeEventListener("message",a),o}function T(n,r){const a=new Map;async function o(e,o){let i=a.get(e);i||(i=function(){const e=new TransformStream;return{stream:e,writer:e.writable.getWriter()}}(),a.set(e,i),async function(e,a){const o=await u(a.stream.readable.getReader()),i=await r(o),s=x(v(n,t(new Uint8Array(4),e),16384));await y(s,i)}(e,i)),await i.writer.write(o)}async function i(t){const n=new Uint8Array(t.data),r=e(n);await o(r,n.slice(4))}return n.addEventListener("message",i),()=>{n.removeEventListener("message",i)}}export{k as createWebRTCFetch,T as createWebRTCServer};
//# sourceMappingURL=index.js.map
